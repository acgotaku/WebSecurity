<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no"/>
        
        
        
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>模板引擎与XSS防御 - Web Security </title>

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
        <script>
          var cb = function() {
            var l = document.createElement('link'); l.rel = 'stylesheet';
            l.href = '../../../css/main.css';
            var h = document.getElementsByTagName('head')[0]; h.parentNode.insertBefore(l, h);
          };
          var raf = requestAnimationFrame || mozRequestAnimationFrame ||
              webkitRequestAnimationFrame || msRequestAnimationFrame;
          if (raf) raf(cb);
          else window.addEventListener('load', cb);
        </script>
        
    </head>

    <body>

        <div class="navbar-fixed">
<nav class="blue lighten-1" role="navigation">
    <div class="nav-wrapper container">
    <a id="logo-container" href="../../.." class="brand-logo center">Web Security</a>
    <ul class="right hide-on-med-and-down">
        <li >
            <a rel="next" href="../Overview">
                <i class="mdi-hardware-keyboard-arrow-left left"></i> Previous
            </a>
        </li>
        <li >
            <a rel="prev" href="../csrf">
                Next <i class="mdi-hardware-keyboard-arrow-right right"></i>
            </a>
        </li>

      </ul>
    <ul id="slide-out" class="side-nav">
    
    
        <li class="no-padding">
            <ul class="collapsible collapsible-accordion">
            <li class="bold">
                <a href="javascript:void(0)" class="collapsible-header waves-effect waves-teal">XSS</a>
                <div class="collapsible-body">
                    <ul>
                    
                        <li >
                            <a href="../../XSS/Overview" class="truncate">XSS</a>
                        </li>
                    
                        <li >
                            <a href="../../XSS/XSS-Cookie" class="truncate">Stealing Cookie With XSS</a>
                        </li>
                    
                        <li >
                            <a href="../../XSS/CSS-history-hack" class="truncate">CSS History Hack</a>
                        </li>
                    
                        <li >
                            <a href="../../XSS/XSS-Worm" class="truncate">XSS Worm</a>
                        </li>
                    
                        <li >
                            <a href="../../XSS/XSS-Defense" class="truncate">XSS Defense</a>
                        </li>
                    
                    </ul>
                </div>
            </li>
            </ul>
        </li>
    
    
    
        <li class="no-padding">
            <ul class="collapsible collapsible-accordion">
            <li class="bold">
                <a href="javascript:void(0)" class="collapsible-header waves-effect waves-teal">Browser Security</a>
                <div class="collapsible-body">
                    <ul>
                    
                        <li >
                            <a href="../../Browser_Security/Same-Origin-Policy" class="truncate">Same Origin Policy</a>
                        </li>
                    
                        <li >
                            <a href="../../Browser_Security/Browser-Sandbox" class="truncate">Browser Sandbox</a>
                        </li>
                    
                        <li >
                            <a href="../../Browser_Security/Malicious-URL-interception" class="truncate">Malicious URL interception</a>
                        </li>
                    
                    </ul>
                </div>
            </li>
            </ul>
        </li>
    
    
    
        <li class="no-padding">
            <ul class="collapsible collapsible-accordion">
            <li class="bold">
                <a href="javascript:void(0)" class="collapsible-header waves-effect waves-teal">Web服务配置安全</a>
                <div class="collapsible-body">
                    <ul>
                    
                        <li >
                            <a href="../../Web_Server_Sercurity/Web-Server-Sercurity" class="truncate">Web Server Sercurity</a>
                        </li>
                    
                        <li >
                            <a href="../../Web_Server_Sercurity/Apache2-WAF" class="truncate">Apache2 ModSecurity</a>
                        </li>
                    
                    </ul>
                </div>
            </li>
            </ul>
        </li>
    
    
    
        <li class="no-padding">
            <ul class="collapsible collapsible-accordion">
            <li class="bold">
                <a href="javascript:void(0)" class="collapsible-header waves-effect waves-teal">SQL_injection</a>
                <div class="collapsible-body">
                    <ul>
                    
                        <li >
                            <a href="../../SQL_injection/Overview" class="truncate">Overview</a>
                        </li>
                    
                        <li >
                            <a href="../../SQL_injection/SQL_injection" class="truncate">SQL_injection</a>
                        </li>
                    
                        <li >
                            <a href="../../SQL_injection/SQL_injection_defence" class="truncate">SQL_injection defence</a>
                        </li>
                    
                    </ul>
                </div>
            </li>
            </ul>
        </li>
    
    
    
        <li class="no-padding">
            <ul class="collapsible collapsible-accordion">
            <li class="bold">
                <a href="javascript:void(0)" class="collapsible-header waves-effect waves-teal">Clickjacking</a>
                <div class="collapsible-body">
                    <ul>
                    
                        <li >
                            <a href="../../Clickjacking/Overview" class="truncate">Overview</a>
                        </li>
                    
                        <li >
                            <a href="../../Clickjacking/Click_Jacking" class="truncate">Click_Jacking</a>
                        </li>
                    
                        <li >
                            <a href="../../Clickjacking/Click_Jacking_defence" class="truncate">Click Jacking defence</a>
                        </li>
                    
                    </ul>
                </div>
            </li>
            </ul>
        </li>
    
    
    
        <li class="no-padding">
            <ul class="collapsible collapsible-accordion">
            <li class="bold">
                <a href="javascript:void(0)" class="collapsible-header waves-effect waves-teal">CSRF</a>
                <div class="collapsible-body">
                    <ul>
                    
                        <li >
                            <a href="../../CSRF/Overview" class="truncate">CSRF</a>
                        </li>
                    
                        <li >
                            <a href="../../CSRF/CSRF_Attack" class="truncate">CSRF Attack</a>
                        </li>
                    
                        <li >
                            <a href="../../CSRF/CSRF_Defense" class="truncate">CSRF Defense</a>
                        </li>
                    
                    </ul>
                </div>
            </li>
            </ul>
        </li>
    
    
    
        <li class="no-padding active">
            <ul class="collapsible collapsible-accordion">
            <li class="bold">
                <a href="javascript:void(0)" class="collapsible-header waves-effect waves-teal">Web框架安全</a>
                <div class="collapsible-body">
                    <ul>
                    
                        <li >
                            <a href="../Overview" class="truncate">Web框架安全概述</a>
                        </li>
                    
                        <li class="active">
                            <a href="." class="truncate">模板引擎与XSS防御</a>
                        </li>
                    
                        <li >
                            <a href="../csrf" class="truncate">Web框架与CSRF防御</a>
                        </li>
                    
                    </ul>
                </div>
            </li>
            </ul>
        </li>
    
    
    
        <li class="no-padding">
            <ul class="collapsible collapsible-accordion">
            <li class="bold">
                <a href="javascript:void(0)" class="collapsible-header waves-effect waves-teal">拒绝服务攻击</a>
                <div class="collapsible-body">
                    <ul>
                    
                        <li >
                            <a href="../../DOS/Overviewed" class="truncate">DOS攻击原理</a>
                        </li>
                    
                        <li >
                            <a href="../../DOS/general-dos" class="truncate">通用的DoS攻击技术</a>
                        </li>
                    
                    </ul>
                </div>
            </li>
            </ul>
        </li>
    
    
    
        <li class="no-padding">
            <ul class="collapsible collapsible-accordion">
            <li class="bold">
                <a href="javascript:void(0)" class="collapsible-header waves-effect waves-teal">Access_Control</a>
                <div class="collapsible-body">
                    <ul>
                    
                        <li >
                            <a href="../../Access_Control/Overview" class="truncate">Access_Control</a>
                        </li>
                    
                        <li >
                            <a href="../../Access_Control/DAC" class="truncate">DAC</a>
                        </li>
                    
                        <li >
                            <a href="../../Access_Control/MAC" class="truncate">MAC</a>
                        </li>
                    
                        <li >
                            <a href="../../Access_Control/RBAC" class="truncate">RBAC</a>
                        </li>
                    
                    </ul>
                </div>
            </li>
            </ul>
        </li>
    
    

    </ul>
      <a href="javascript:void(0)" data-activates="slide-out" class="button-collapse show-on-large"><i class="mdi-navigation-menu"></i></a>
    </div>
  </nav>
</div>

        <div class="container">
            <div class="row">
                <div class="col s12 m3"><div class="hide-on-small-only index">
  <ul class="section table-of-contents">
    
        <li class="main active"><a href="#xss">XSS防御</a></li>
        
            <li><a href="#_1">防御方法</a></li>
        
            <li><a href="#django-xss">Django 与 XSS 防御</a></li>
        
            <li><a href="#velocity-xss">Velocity 与 XSS 防御</a></li>
        
            <li><a href="#_2">总结</a></li>
        
    
  </ul>
</div></div>
                <div class="col s12 m9" role="main"><h1 id="xss">XSS防御</h1>
<p>模板引擎与XSS防御    </p>
<hr />
<h2 id="_1"><strong>防御方法</strong></h2>
<p>在View层，可以解决XSS问题。XSS攻击实在用户的浏览器上执行的。其形成过程则是在服务器端页面渲染时，注入了恶意 的HTML代码导致的。从MVC架构来说，是发生在View层，因此可以使用“<strong>输出编码</strong>”的方式来防御，即针对不同上下文的XSS攻击场景，使用不同的编码方式。    </p>
<p>“输出编码”的防御方法可以总结为以下几种：      </p>
<ul>
<li>在HTML标签中输出变量     </li>
<li>在HEML属性中输出变量</li>
<li>在script标签中输出变量</li>
<li>在事件中输出变量</li>
<li>在CSS中输出变量</li>
<li>在URL中输出变量   </li>
</ul>
<p>针对不同的情况，使用不同的编码函数。      </p>
<hr />
<h2 id="django-xss"><strong>Django 与 XSS 防御</strong></h2>
<p>在当前流行的MVC框架中， View层常用的技术是使用模板引擎对页面进行渲染，比如在Django中就是用了 Django Templates 作为模板引擎。模板引擎本身会提供一些编码方法。比如在 Django Templates 中，使用 filters 中的 escape 作为 HtmlEncode 的方法：    </p>
<pre><code>    &lt;h1&gt;hello,  {{ name|escape }}!&lt;/h1&gt;
</code></pre>
<p>Django Templates 同时支持 auto-escape，符合 Secure by Default 原则。现在的 Django Templates 默认是将 aotu-escape 开启的，所有的变量都会经过 HTMLEncode后输出。默认是编码了5个字符：    </p>
<pre><code>    &lt; is converted to &amp;lt;
    &gt; is converted to &amp;gt;
    ' (single queto) is converted to &amp;#39;
    " (double quote) is converted to &amp;quot;
    &amp; is converted to &amp;amp;
</code></pre>
<p>如果要关闭 auto-escape，则需要使用以下方法：    </p>
<pre><code>    {{ data|safe }}
</code></pre>
<p>或者    </p>
<pre><code>    {% autoescape off %}
        Hello {{ name }}
    {% endautoescape %}
</code></pre>
<p>为了方便，很多程序员可能会选择关闭 auto-escape。要检查 auto-escape 是否被关闭也很简单，搜索代码里是否出现上面两种情况即可。    </p>
<p>但是如前文所述，最好的XSS防御方案，在不同的场景需要使用不同的编码函数。如果统一使用者5个字符的HTMLEncode， 则很可能会被攻击者绕过。由此看来，这种 auto-escape 的方案也不是很完善。   </p>
<hr />
<h2 id="velocity-xss"><strong>Velocity 与 XSS 防御</strong></h2>
<p>在模板引擎Velocity中，也提供了类似的机制，但有所不同的是，Velocity 默认是没有开启 HtmlEncode 的。   </p>
<p>在 Velocity 中，可以通过 Event Handler 来进行 HTMLEncode。    </p>
<pre><code>    eventhandler.referenceinsertion.class = org.apache.velocity.app.event.implement.
    EscapeHtmlReference
    eventhandler.escape.html.match = /msg.*/
</code></pre>
<p>使用方法如下，这里同时还加入了一个转义SQL语句的 Event Handler。    </p>
<pre><code>    ...

    import org.apache.velocity.app.event.EventCartridge;
    import org.apache.velocity.app.event.ReferenceInsertionEventHandler;
    import org.apache.velocity.app.event.implement.EscapeHtmlReference;
    import org.apache.velocity.app.event.implement.EscapeSqlReference;

    ...

    public class Test
    {
        public void myTest()
        {
            ...

            /**
             * Make a cartridge to hold the event handlers
             */
            EventCartridge ec = new EventCartridge();

            /**
             * then register and chain two escape-related handlers
             */
            ec.addEventHandler(new EscapeHtmlReference());
            ec.addEventHandler(new EscapeSqlReference());

             /**
             * and then finally let it attach itself to the context
             */
            ec.attachToContext(context);

             /**
             * now merge your template with the context as you mormally do
             */

            ...
        }

    }
</code></pre>
<p>但 Velocity 提供的处理机制，与 Django 的 auto-escape 所提供的机制是类似的，都只进行了 HTMLEncode，而未细分编码使用的具体场景。不过在模板引擎中，可以实现自定义的编码函数，应用于不同场景。在 Django 中是使用自定义 filters，在 Velocity 中则可以使用“宏”（velocimacro），比如：</p>
<pre><code>    XML编码输出，将会执行 XML Encode 输出
    #SXML($xml)

    JS编码输出，将会执行JavaScript Encode输出
    #SJS($js)
</code></pre>
<p>通过自定义的方法，使得XSS防御的功能得到完善；同时在模板系统中，搜索不安全的变量也有了依据，甚至在代码检测工具中，可以自动判断出需要使用那一种安全的编码方式。    </p>
<hr />
<h2 id="_2"><strong>总结</strong></h2>
<p>在模板引擎中，可以实现自定义的编码函数，来应用于不同的场景。我们可以依据是否有细分场景使用不同的编码方式来判断XSS的安全方案是否完善。在很多 Web 框架官方文档中推荐的用法，就是存在缺陷的。Web 框架的开发者在设计安全方案时，有时会缺乏来自安全专家的建议。所以开发者在使用框架时，应该慎重对待安全问题。    </p>
</div>
            </div>
        </div>
        <footer  class="page-footer transparent">
    <div class="footer-copyright">
      <div class="container center">
        
            <span>Copyright &copy; 2015, <a href="https://github.com/acgotaku/WebSecurity">CSS WebSecurity</a>.</span>
        
      </div>
    </div>
        </footer>

        <script src="../../../js/jquery-2.1.1.min.js"></script>
        <script src="../../../js/prism.js"></script>
        <script src="../../../js/materialize.js"></script>
        <script src="../../../js/init.js"></script>
    </body>
</html>